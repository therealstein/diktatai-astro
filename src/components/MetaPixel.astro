---
// Meta Pixel - loads only when visitor comes from Meta ads
// Detected via fbclid parameter or utm_source=facebook/instagram/meta
---

<script is:inline>
(function() {
  // Check if coming from Meta ads
  function isFromMetaAds() {
    var params = new URLSearchParams(window.location.search);
    var fbclid = params.get('fbclid');
    var utmSource = (params.get('utm_source') || '').toLowerCase();

    // Also check sessionStorage in case user navigates within site
    if (sessionStorage.getItem('meta_ads_visitor') === 'true') {
      return true;
    }

    if (fbclid || utmSource === 'facebook' || utmSource === 'instagram' || utmSource === 'meta' || utmSource === 'fb') {
      sessionStorage.setItem('meta_ads_visitor', 'true');
      return true;
    }

    return false;
  }

  // Get page info for tracking
  function getPageInfo() {
    var path = window.location.pathname;
    var pageName = 'homepage';

    if (path !== '/' && path !== '') {
      // Extract page name from path, e.g., /en/pricing -> pricing
      var parts = path.split('/').filter(Boolean);
      pageName = parts[parts.length - 1] || 'homepage';
    }

    return {
      page_name: pageName,
      page_path: path,
      page_locale: document.documentElement.lang || 'de'
    };
  }

  // Initialize Meta Pixel
  function initMetaPixel() {
    if (window.fbq) return;

    (function(f, b, e, v, n, t, s) {
      if (f.fbq) return;
      n = f.fbq = function() {
        n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments);
      };
      if (!f._fbq) f._fbq = n;
      n.push = n;
      n.loaded = true;
      n.version = '2.0';
      n.queue = [];
      t = b.createElement(e);
      t.async = true;
      t.src = v;
      s = b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t, s);
    })(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js', null, null, null);

    window.fbq('init', '672991722114455');

    // Track PageView
    window.fbq('track', 'PageView');

    // Track ViewContent with page details
    var pageInfo = getPageInfo();
    window.fbq('track', 'ViewContent', {
      content_name: 'Page: ' + pageInfo.page_name,
      content_category: 'page_view',
      content_ids: [pageInfo.page_path],
      content_type: 'page',
      language: pageInfo.page_locale
    });
  }

  // Track custom events - exposed globally
  window.trackMetaEvent = function(eventName, data, isStandard) {
    if (window.fbq) {
      if (isStandard) {
        window.fbq('track', eventName, data);
      } else {
        window.fbq('trackCustom', eventName, data);
      }
    }
  };

  // Convenience function for ViewContent tracking
  window.trackMetaViewContent = function(contentName, contentCategory, contentIds) {
    if (window.fbq) {
      window.fbq('track', 'ViewContent', {
        content_name: contentName,
        content_category: contentCategory || 'content',
        content_ids: contentIds || [],
        content_type: 'product'
      });
    }
  };

  // Only init if from Meta ads
  if (isFromMetaAds()) {
    // Defer loading to not block page render
    if (document.readyState === 'complete') {
      initMetaPixel();
    } else {
      window.addEventListener('load', initMetaPixel);
    }
  }

  // Track CTA clicks via data-track-cta attribute
  document.addEventListener('click', function(e) {
    var target = e.target.closest('[data-track-cta]');
    if (target && window.trackMetaEvent) {
      var ctaName = target.getAttribute('data-track-cta');
      window.trackMetaEvent('InitiateCheckout', {
        content_name: ctaName,
        content_category: 'cta_click',
        content_ids: [ctaName]
      }, true);
    }
  });

  // Track section views via data-track-view attribute using IntersectionObserver
  if ('IntersectionObserver' in window) {
    var viewedSections = {};
    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting && window.trackMetaEvent) {
          var sectionName = entry.target.getAttribute('data-track-view');
          if (sectionName && !viewedSections[sectionName]) {
            viewedSections[sectionName] = true;
            window.trackMetaEvent('ViewContent', {
              content_name: 'Section: ' + sectionName,
              content_category: 'section_view',
              content_ids: [sectionName]
            }, true);
          }
        }
      });
    }, { threshold: 0.5 });

    // Observe elements after DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('[data-track-view]').forEach(function(el) {
        observer.observe(el);
      });
    });
  }
})();
</script>

<!-- Meta Pixel noscript fallback - only renders if JS detects Meta ads visitor -->
<noscript>
  <img
    height="1"
    width="1"
    style="display:none"
    src="https://www.facebook.com/tr?id=672991722114455&ev=PageView&noscript=1"
    alt=""
  />
</noscript>
